// ===== DATI CSV =====
const csvData = `column0,column1,column2,column3,column4
-19,10,-20,-24,-69
-69,-45,-95,-42,-66
98,78,67,0,-29
11,63,31,-45,99
-37,41,-84,-42,17
-5,-18,98,36,-43
-49,-76,81,51,89
-63,94,88,-56,64
53,70,-60,-24,-19
-97,47,-24,-93,-16
-23,-89,-26,-3,40
-31,-50,-64,66,13
83,52,91,3,-53
6,82,-19,72,28
-97,90,49,-54,35
40,97,-84,72,-62
8,70,79,-55,50
42,3,53,-54,-36
69,94,13,39,66
60,-39,11,30,-7
-2,98,-74,6,61
73,45,-7,-81,15
3,44,17,84,61
65,-77,-54,51,36
83,-32,-73,9,-66
68,-82,-49,84,-52
-71,-49,-25,72,46
37,85,38,-79,25
59,22,40,3,95
-86,99,-39,-25,8
-6,30,7,-42,26
94,-7,71,3,75
-66,-58,-50,-27,-6
5,-82,-39,81,-24
0,-69,-10,-66,86
69,56,62,-36,-35
-14,61,-95,-72,68
-97,-45,32,38,43
62,-43,-44,70,-53
69,-29,-2,-12,-75
-95,-19,-39,90,32
-68,-42,6,-78,-82
-35,-83,34,72,44
3,61,-30,36,56
53,-91,-68,48,-19
-11,-50,82,69,86
-20,-72,33,-9,-10
71,-72,-41,-89,-48
-9,53,60,87,-21
50,-13,69,18,44
-67,-80,60,48,-54
49,53,-93,-57,4
74,32,11,35,-68
67,-24,2,9,39
23,41,29,-54,-67
-64,48,-67,21,-32
-79,-93,78,72,-60
-28,34,31,-99,91
27,-60,2,27,-77
-52,47,94,-33,-98
48,-69,-32,-93,-85
-46,-20,31,-21,18
-4,-51,-5,99,10
-82,19,-57,38,19
-49,-75,-98,-63,36
-19,100,43,18,35
-3,67,34,40,29
23,-11,-65,87,-23
28,-60,36,-68,68
-50,-2,99,54,29
-77,-23,-17,82,98
-46,-98,12,-45,14
76,-6,-22,-69,-57
23,4,66,-90,-14
76,88,-88,-54,-28
44,12,84,-87,-69
-46,-52,-9,-99,44
54,66,-79,60,-60
75,-100,-8,-33,31
-37,-45,-59,-18,-40
-75,88,53,38,21
-83,-54,-90,63,-99
-32,55,18,-18,7
-62,-16,59,-66,-30
62,78,-4,-93,99
86,4,5,-81,-66
30,4,-53,63,-47
-8,-62,-71,75,47
77,-72,39,66,73
-90,-80,10,54,16
-28,84,-90,31,-20
-32,-32,-31,57,-93
65,-82,-10,81,-47
-56,69,-41,-45,-14
-30,73,71,-33,97
-57,-87,31,85,94
-56,6,17,24,-58
11,43,52,-16,-44
-16,43,37,69,-72
11,39,-34,-78,-87
11,63,39,-42,-23
27,74,38,9,-47
2,-92,80,66,-11
29,39,67,24,-9
-11,2,-55,93,51
17,8,-27,-54,54
100,58,-16,6,44
-95,87,-92,-99,93
76,33,45,9,-27
41,36,86,87,-76
-87,77,95,99,42
-90,70,-97,57,88
-81,77,-72,-85,-42
16,67,73,73,-17
-5,-18,-33,-60,100
63,-96,48,-15,-95
73,-77,38,3,29
-41,38,29,-99,49
31,89,-1,84,91
77,-36,63,69,-25
-44,-3,36,49,-79
-98,-6,-3,6,37
73,-59,85,61,9
-75,0,67,-23,28
-16,-45,31,30,-12
-40,-50,-73,72,5
-20,41,-82,36,-58
11,62,-15,48,26
-47,11,-99,-51,-25
59,-78,-59,-80,41
-52,55,-55,40,-27
-57,84,87,12,18
-69,95,-6,-90,-25
-21,18,32,-43,-19
-67,92,-100,38,52
59,42,-88,-69,-96
79,-79,2,69,93
-76,17,-75,-30,44
-98,4,-45,96,92
37,65,-26,-30,87
-33,-63,-76,-87,-4
-99,-67,-67,-15,-50
78,-59,-6,-66,78
50,-75,76,45,20
5,-8,48,84,40
71,37,-37,30,-61
-52,-85,-18,-49,52
96,52,-79,72,-33
70,-43,61,84,-36
55,60,-34,-24,-12
-76,-48,9,-21,-36
-97,-88,93,24,10
-15,45,87,34,33
-34,48,-22,-45,-60
-69,12,31,-90,30
-30,12,12,81,-27
79,34,-33,-93,-81
28,-91,-51,-18,-9
13,-69,57,-90,31
81,-41,98,-21,67
-57,-81,30,72,-76
-4,72,40,-61,21
54,30,91,-66,40
-34,45,-6,54,86
23,18,12,15,-84
-53,73,-23,-18,-86
-99,22,88,6,31
-48,2,68,24,-100
49,22,89,-51,-98
99,-38,-37,-90,-94
-13,-87,91,41,6
-95,-27,74,-6,70
17,-78,-36,81,45
-14,-95,28,-54,27
-81,-89,-29,27,-19
-53,-98,72,-47,62
-52,-92,-48,-87,72
5,27,-94,51,-74
-24,5,-50,-74,98
-39,48,28,-36,-80
20,25,-94,34,-86
-76,8,-6,44,-61
56,18,-54,-63,11
23,-59,92,-54,-61
85,56,-14,-56,-28
-24,55,35,30,-82
5,-55,50,21,98
2,56,49,-6,52
-98,31,-4,60,-24
96,11,-79,-60,80
87,-49,42,1,72
54,-24,74,-36,-32
70,49,53,-51,-12
48,29,4,-39,-97
81,59,-16,38,16
-20,-19,20,-99,71
11,90,-73,-54,-50
82,-92,74,3,37
78,-96,-23,-15,5
-5,-84,4,-39,18
79,19,-84,93,87
-5,45,-18,30,-33
54,60,-97,81,35
62,-55,-77,39,-57
57,69,40,9,-44
-34,42,-29,-75,-45
1,52,-85,-42,42
-30,19,-21,-12,-54
62,49,73,-84,-76
-66,-46,38,-9,68
53,-7,-12,9,-5
-56,-42,11,31,-88
-2,24,-78,75,-68
-65,64,86,73,72
-72,-47,90,-92,70
-45,15,87,-15,40
49,85,75,33,-11
-33,-53,80,54,-61
62,-44,65,-55,38
38,-49,-89,40,31
20,-45,93,24,-67
-12,-84,-8,35,-3
-3,17,-56,100,-47
12,16,31,-72,-15
47,-3,22,18,-41
-40,-49,-26,-51,-87
-80,-93,69,92,36
24,21,-67,-99,-8
77,33,-30,21,-67
92,-99,-43,-24,-8
-2,-80,-73,9,-51
36,-89,-21,-3,88
43,-74,-88,64,-15
83,-65,72,31,68
88,-22,3,-51,-68
-23,72,-52,72,-15
5,-11,58,-69,0
52,-66,-37,75,-33
-70,-29,22,-30,81
-7,15,-60,84,-90
-16,54,80,15,3
54,66,-29,28,-68
28,-77,-61,75,-34
-23,-13,54,35,19
34,-34,22,96,-53
41,-56,-93,-87,-79
34,38,52,57,59
49,67,-95,37,-44
63,7,-12,-36,-83
1,-80,-36,34,-70
-70,47,59,-93,-80
0,-1,100,34,84
88,-21,-89,15,35
-98,35,-70,71,46
-86,-29,-54,79,-59
-74,100,71,-65,-24
-64,-18,10,-81,-42
64,17,53,38,95
82,11,62,37,4
-58,-27,100,39,-59
2,-11,-74,-48,12
54,36,38,6,-5
-62,60,97,37,14
-28,68,4,62,-21
57,81,-23,62,-66
27,93,-76,-42,3
-61,85,-62,41,-96
35,2,73,-9,-48
27,-94,-47,45,-80
60,-6,64,75,-46
5,-80,59,35,9
-54,79,9,-27,-57
50,-58,-11,15,-41
92,26,-41,87,64
28,-27,-66,-3,92
-34,91,17,-38,45
-30,-96,-69,69,-58
-50,-5,-11,9,-47
79,-90,75,51,-6
-95,93,64,-20,42
-92,-13,89,50,-85
52,69,57,12,-63
-90,0,78,69,9
96,5,-98,58,-45
87,30,-83,-9,79
54,1,52,21,82
48,-19,-10,15,-46
69,29,26,-33,-81
1,-83,13,-27,-43
-68,-55,-74,3,-63
-68,-77,-46,-18,50
-34,-87,83,2,-66
48,42,45,40,93
-95,28,-29,-72,81
46,40,-68,-86,27
-86,85,94,33,-8
-74,-90,57,-81,-86
-8,-3,-30,69,-15
28,48,60,40,5
-15,73,53,-48,6
-80,-11,42,61,-19
-19,14,-34,-91,22
25,-26,94,24,-19
62,39,12,37,-62
89,83,4,0,4
-62,10,-33,-27,-18
43,-86,-14,-6,13
-12,14,22,24,-34
-50,-66,-19,63,-73
56,55,-27,-57,-44
-52,12,4,-39,65
60,-9,-57,-45,24
-39,63,13,39,-37
-57,67,31,-63,-45
11,15,-77,-6,13
93,-6,-76,-30,95
4,23,-48,42,-47`;

// ===== VARIABILI GLOBALI =====
let validRows = []; // array che contiene le righe valide
let displayedRows = []; // array che conterrà le righe visualizzate (dopo filtri)
let stats = {}; // oggetto che conterrà le statistiche calcolate
let sortColumn = null; // colonna attualmente ordinata
let sortDirection = 'asc'; // direzione ordinamento (asc o desc)
let currentFilter = 'all'; // filtro attualmente applicato
let highlightType = null; // tipo di evidenziazione attiva (mean, mode, null)

// ===== FUNZIONE PRINCIPALE =====
// questa funzione viene eseguita quando la pagina è caricata
document.addEventListener('DOMContentLoaded', function() {
    // 1. parse del CSV e filtro delle righe valide
    parseAndFilterCSV();
    
    // 2. calcolo delle statistiche
    calculateStatistics();
    
    // 3. aggiornamento dell'interfaccia
    updateUI();
    
    // 4. creazione dei grafici
    createCharts();
    
    // 5. riempimento delle tabelle
    populateTables();
});

// ===== PARSE E FILTRO DEL CSV =====
function parseAndFilterCSV() {
    // divide il CSV in righe
    const lines = csvData.trim().split('\n');
    
    // salta la prima riga (header) e processiamo le altre
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => parseFloat(v.trim()));
        
        const row = {
            column0: values[0],
            column1: values[1],
            column2: values[2],
            column3: values[3],
            column4: values[4]
        };
        
        // controlliamo se la riga è valida secondo le regole
        // regola 1: column3 deve essere un intero tra 30 (incluso) e 42 (escluso)
        // regola 2: column3 deve essere multiplo di 3
        const col3 = row.column3;
        const isInteger = Number.isInteger(col3);
        const inRange = col3 >= 30 && col3 < 42;
        const isMultipleOf3 = col3 % 3 === 0;
        
        // se entrambe le regole sono soddisfatte, aggiungiamo la riga
        if (isInteger && inRange && isMultipleOf3) {
            validRows.push(row);
        }
    }
    
    // inizialmente, le righe visualizzate sono tutte quelle valide
    displayedRows = [...validRows];
}

// ===== CALCOLO DELLE STATISTICHE =====
function calculateStatistics() {
    // estraiamo i valori di ogni colonna
    const col0Values = validRows.map(r => r.column0);
    const col1Values = validRows.map(r => r.column1);
    const col2Values = validRows.map(r => r.column2);
    const col3Values = validRows.map(r => r.column3);
    const col4Values = validRows.map(r => r.column4);
    
    // calcoliamo le statistiche richieste
    stats = {
        meanCol0: mean(col0Values),           // media di colonna 0
        stdDevCol1: stdDev(col1Values),       // deviazione standard di colonna 1
        modeCol2: mode(col2Values),           // moda di colonna 2
        medianCol3: median(col3Values),       // mediana di colonna 3
        meanCol4: mean(col4Values),           // media di colonna 4
        stdDevCol4: stdDev(col4Values),       // deviazione standard di colonna 4
        validCount: validRows.length          // numero di righe valide
    };
}

// ===== FUNZIONI STATISTICHE =====

// calcola la media di un array
function mean(arr) {
    return arr.reduce((a, b) => a + b, 0) / arr.length;
}

// calcola la deviazione standard di un array
function stdDev(arr) {
    const avg = mean(arr);
    const squareDiffs = arr.map(value => Math.pow(value - avg, 2));
    return Math.sqrt(mean(squareDiffs));
}

// calcola la moda (valore più frequente) di un array
function mode(arr) {
    const freq = {};
    arr.forEach(value => {
        freq[value] = (freq[value] || 0) + 1;
    });
    
    let maxFreq = 0;
    let modeVal = arr[0];
    
    for (let key in freq) {
        if (freq[key] > maxFreq) {
            maxFreq = freq[key];
            modeVal = parseFloat(key);
        }
    }
    
    return modeVal;
}

// calcola la mediana di un array
function median(arr) {
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    
    // se la lunghezza è pari, la mediana è la media dei due valori centrali
    if (sorted.length % 2 === 0) {
        return (sorted[mid - 1] + sorted[mid]) / 2;
    }
    // se la lunghezza è dispari, la mediana è il valore centrale
    return sorted[mid];
}

// ===== AGGIORNAMENTO INTERFACCIA =====
function updateUI() {
    // aggiorniamo il conteggio delle righe valide
    document.getElementById('validCount').textContent = stats.validCount;
    
    // aggiorniamo le statistiche nelle card
    document.getElementById('meanCol0').textContent = stats.meanCol0.toFixed(2);
    document.getElementById('stdDevCol1').textContent = stats.stdDevCol1.toFixed(2);
    document.getElementById('modeCol2').textContent = stats.modeCol2.toFixed(2);
    document.getElementById('medianCol3').textContent = stats.medianCol3.toFixed(2);
    document.getElementById('meanCol4').textContent = stats.meanCol4.toFixed(2);
    document.getElementById('stdDevCol4').textContent = stats.stdDevCol4.toFixed(2);
}

// ===== CREAZIONE GRAFICI =====
let barChart = null;
let pieChart = null;

function createCharts() {
    // colori pastello per i grafici
    const colors = ['#B8A7D6', '#F0C4D5', '#FFEAB3', '#FFD4B8', '#C5B8E0'];
    
    // GRAFICO A BARRE
    const barCtx = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Mean Col0', 'StdDev Col1', 'Mode Col2', 'Median Col3', 'Mean Col4'],
            datasets: [{
                label: 'Valore',
                data: [
                    stats.meanCol0.toFixed(2),
                    stats.stdDevCol1.toFixed(2),
                    stats.modeCol2.toFixed(2),
                    stats.medianCol3.toFixed(2),
                    stats.meanCol4.toFixed(2)
                ],
                backgroundColor: colors,
                borderColor: colors.map(c => c),
                borderWidth: 2,
                borderRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#FFFFFF',
                    titleColor: '#8B7EA8',
                    bodyColor: '#8B7EA8',
                    borderColor: '#B8A7D6',
                    borderWidth: 3,
                    titleFont: {
                        family: 'Press Start 2P',
                        size: 10
                    },
                    bodyFont: {
                        family: 'Press Start 2P',
                        size: 10
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            family: 'Press Start 2P',
                            size: 20
                        },
                        color: '#8B7EA8'
                    },
                    grid: {
                        color: 'rgba(139, 126, 168, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            family: 'Press Start 2P',
                            size: 15
                        },
                        color: '#8B7EA8',
                        maxRotation: 0,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // GRAFICO A TORTA
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Mean Col0', 'Mode Col2', 'Median Col3'],
            datasets: [{
                data: [
                    Math.abs(stats.meanCol0),
                    Math.abs(stats.modeCol2),
                    Math.abs(stats.medianCol3)
                ],
                backgroundColor: [colors[0], colors[2], colors[3]],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            family: 'Press Start 2P',
                            size: 20
                        },
                        color: '#8B7EA8',
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: '#FFFFFF',
                    titleColor: '#8B7EA8',
                    bodyColor: '#8B7EA8',
                    borderColor: '#B8A7D6',
                    borderWidth: 3,
                    titleFont: {
                        family: 'Press Start 2P',
                        size: 20
                    },
                    bodyFont: {
                        family: 'Press Start 2P',
                        size: 20
                    }
                }
            }
        }
    });
}

// ===== POPOLAMENTO TABELLE =====
function populateTables() {
    // tabella delle righe valide (statica)
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    validRows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.column0}</td>
            <td>${row.column1}</td>
            <td>${row.column2}</td>
            <td>${row.column3}</td>
            <td>${row.column4}</td>
        `;
        tableBody.appendChild(tr);
    });
    
    // tabella del data explorer (dinamica)
    updateExplorerTable();
}

// ===== DATA EXPLORER - AGGIORNAMENTO TABELLA =====
function updateExplorerTable() {
    const explorerTableBody = document.getElementById('explorerTableBody');
    explorerTableBody.innerHTML = '';
    
    // aggiorniamo i contatori
    document.getElementById('displayedCount').textContent = displayedRows.length;
    document.getElementById('totalCount').textContent = validRows.length;
    
    // riempiamo la tabella con le righe visualizzate
    displayedRows.forEach((row, idx) => {
        const tr = document.createElement('tr');
        
        // controlliamo se la riga deve essere evidenziata
        if (highlightType === 'mean' && Math.abs(row.column0 - stats.meanCol0) < 10) {
            tr.classList.add('highlight-mean');
        } else if (highlightType === 'mode' && row.column2 === stats.modeCol2) {
            tr.classList.add('highlight-mode');
        }
        
        tr.innerHTML = `
            <td class="${sortColumn === 'column0' ? 'sorted-column' : ''}">${row.column0}</td>
            <td class="${sortColumn === 'column1' ? 'sorted-column' : ''}">${row.column1}</td>
            <td class="${sortColumn === 'column2' ? 'sorted-column' : ''}">${row.column2}</td>
            <td>${row.column3}</td>
            <td class="${sortColumn === 'column4' ? 'sorted-column' : ''}">${row.column4}</td>
        `;
        explorerTableBody.appendChild(tr);
    });
    
    // aggiorniamo gli header della tabella per mostrare quale colonna è ordinata
    updateTableHeaders();
    
    // mostriamo quante righe sono evidenziate
    if (highlightType) {
        const highlightedCount = displayedRows.filter(row => {
            if (highlightType === 'mean') {
                return Math.abs(row.column0 - stats.meanCol0) < 10;
            } else if (highlightType === 'mode') {
                return row.column2 === stats.modeCol2;
            }
            return false;
        }).length;
        
        document.getElementById('highlightedInfo').textContent = 
            `| EVIDENZIATE: ${highlightedCount}`;
    } else {
        document.getElementById('highlightedInfo').textContent = '';
    }
}

// ===== DATA EXPLORER - AGGIORNAMENTO HEADER TABELLA =====
function updateTableHeaders() {
    const headers = document.querySelectorAll('#explorerTable th');
    const columnNames = ['column0', 'column1', 'column2', 'column3', 'column4'];

    headers.forEach((header, idx) => {
        header.classList.remove('sorted');
        
        // aggiungiamo la classe 'sorted' all'header della colonna ordinata
        const columnName = columnNames[idx];
        const baseText = idx === 3 ? 'COL 3' : `COL ${idx}`;
        
        if (sortColumn === columnName) {
            header.classList.add('sorted');
            
            // aggiungiamo la freccia di ordinamento
            const arrow = sortDirection === 'asc' ? ' ↑' : ' ↓';
            if (!header.textContent.includes('↑') && !header.textContent.includes('↓')) {
                header.textContent = baseText + star + arrow;
            }
        } else {
            // rimuoviamo le frecce dagli altri header
            header.textContent = baseText + star;
        }
    });
}

// ===== DATA EXPLORER - ORDINAMENTO =====
function sortData(column) {
    // se clicchiamo sulla stessa colonna, invertiamo la direzione
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    // ordiniamo le righe visualizzate
    displayedRows.sort((a, b) => {
        const aVal = a[column];
        const bVal = b[column];
        return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    });
    
    // aggiorniamo i bottoni
    updateSortButtons();
    
    // aggiorniamo la tabella
    updateExplorerTable();
}

// ===== DATA EXPLORER - RESET ORDINAMENTO =====
function resetSort() {
    sortColumn = null;
    sortDirection = 'asc';
    
    // ricalcoliamo le righe visualizzate applicando il filtro corrente
    applyCurrentFilter();
    
    // aggiorniamo i bottoni
    updateSortButtons();
    
    // aggiorniamo la tabella
    updateExplorerTable();
}

// ===== DATA EXPLORER - AGGIORNAMENTO BOTTONI ORDINAMENTO =====
function updateSortButtons() {
    const sortButtons = document.querySelectorAll('.control-section:first-child .control-btn');
    sortButtons.forEach((btn, idx) => {
        btn.classList.remove('active');
        
        // rimuoviamo le frecce dal testo del bottone
        btn.textContent = btn.textContent.replace(' ↑', '').replace(' ↓', '');
        
        if (idx < 5) { // i primi 5 bottoni sono per le colonne
            const columnName = ['column0', 'column1', 'column2', 'column3', 'column4'][idx];
            if (sortColumn === columnName) {
                btn.classList.add('active');
                const arrow = sortDirection === 'asc' ? ' ↑' : ' ↓';
                btn.textContent = `COL ${idx}${arrow}`;
            } else {
                btn.textContent = `COL ${idx}`;
            }
        }
    });
}

// ===== DATA EXPLORER - FILTRI =====
function filterData(filterType) {
    currentFilter = filterType;
    applyCurrentFilter();
    
    // aggiorniamo i bottoni
    updateFilterButtons();
    
    // aggiorniamo la tabella
    updateExplorerTable();
}

// ===== DATA EXPLORER - APPLICAZIONE FILTRO CORRENTE =====
function applyCurrentFilter() {
    if (currentFilter === 'all') {
        displayedRows = [...validRows];
    } else if (currentFilter === 'col0-positive') {
        displayedRows = validRows.filter(r => r.column0 > 0);
    } else if (currentFilter === 'col0-negative') {
        displayedRows = validRows.filter(r => r.column0 < 0);
    } else if (currentFilter === 'col4-positive') {
        displayedRows = validRows.filter(r => r.column4 > 0);
    } else if (currentFilter === 'col4-negative') {
        displayedRows = validRows.filter(r => r.column4 < 0);
    }
    
    // se c'è un ordinamento attivo, lo riapplichiamo
    if (sortColumn) {
        displayedRows.sort((a, b) => {
            const aVal = a[sortColumn];
            const bVal = b[sortColumn];
            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
        });
    }
}

// ===== DATA EXPLORER - AGGIORNAMENTO BOTTONI FILTRO =====
function updateFilterButtons() {
    const filterButtons = document.querySelectorAll('.btn-filter');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // attiviamo il bottone del filtro corrente
    const filterMap = {
        'all': 0,
        'col0-positive': 1,
        'col0-negative': 2,
        'col4-positive': 3,
        'col4-negative': 4
    };
    
    if (filterMap[currentFilter] !== undefined) {
        filterButtons[filterMap[currentFilter]].classList.add('active');
    }
}

// ===== DATA EXPLORER - EVIDENZIAZIONE =====
function highlightMean() {
    highlightType = highlightType === 'mean' ? null : 'mean';
    updateHighlightButtons();
    updateExplorerTable();
}

function highlightMode() {
    highlightType = highlightType === 'mode' ? null : 'mode';
    updateHighlightButtons();
    updateExplorerTable();
}

function removeHighlight() {
    highlightType = null;
    updateHighlightButtons();
    updateExplorerTable();
}

// ===== DATA EXPLORER - AGGIORNAMENTO BOTTONI EVIDENZIAZIONE =====
function updateHighlightButtons() {
    const meanBtn = document.querySelector('.btn-highlight-mean');
    const modeBtn = document.querySelector('.btn-highlight-mode');
    
    meanBtn.classList.remove('active');
    modeBtn.classList.remove('active');
    
    if (highlightType === 'mean') {
        meanBtn.classList.add('active');
    } else if (highlightType === 'mode') {
        modeBtn.classList.add('active');
    }
}